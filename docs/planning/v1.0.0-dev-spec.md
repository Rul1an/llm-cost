# v1.0.0 Development Specification
## Codename: "FOCUS Export"

**Status:** Ready for Implementation
**Target:** Q1 2026
**Predecessor:** v0.10.0 (FOCUS Foundation)
**Effort Estimate:** 3-5 days

---

## 1. Executive Summary

v1.0.0 delivers the core value proposition of llm-cost: **FOCUS-compliant cost exports** for enterprise FinOps integration. This release implements a single export format optimized for Vantage (our primary enterprise target) while remaining FOCUS-spec compliant.

### Key Amendments (Pre-Implementation Review)
Based on latest SOTA analysis (Dec 2025) and Vantage validation:
1.  **Header Subset**: Strictly adhere to Vantage Supported Columns to avoid import errors.
2.  **Date Attribution**: `ChargePeriodStart` is mandatory for correct time-based cost allocation.
3.  **Memory Safety**: Export mapper uses strict ownership semantics (`deinit`) to prevent leaks during streaming.

---

## 2. Architecture Overview

### Data Flow
```mermaid
graph TD
    M[Manifest (llm-cost.toml)] -->|Prompt Defs| E[Export Command]
    F[Prompt Files] -->|Content| E
    P[Pricing DB] -->|Rates| E

    subgraph Export Engine
        E -->|Resolve Model| Pricing
        E -->|Count Tokens| Tokenizer
        E -->|Derive ID| RID[ResourceId Logic]
        E -->|Map Data| Row[FocusRow (Owned)]
    end

    Row -->|Format CSV| CSV[CSV Writer]
    CSV -->|Stream| Out[stdout / file]
```

### Module Structure
*   `src/export.zig`: Command Coordinator.
*   `src/core/focus/mod.zig`: Public API.
*   `src/core/focus/schema.zig`: Column definitions & Row struct.
*   `src/core/focus/mapper.zig`: Transformation logic (Manifest -> FocusRow).
*   `src/core/focus/csv.zig`: Streaming CSV writing & escaping.

---

## 3. FOCUS Schema Mapping (Vantage Strict)

### Column Specification

This export targets **Vantage Custom Providers**, which accept a specific subset of FOCUS columns. We only emit columns supported by Vantageâ€™s CSV validator.

**CSV Header (Strict Order):**
`ChargePeriodStart,ChargeCategory,BilledCost,ResourceId,ResourceType,RegionId,ServiceCategory,ServiceName,ConsumedQuantity,ConsumedUnit,Tags`

| Column | Type | Required | Source | Notes |
| :--- | :--- | :--- | :--- | :--- |
| `ChargePeriodStart` | date | **Yes** | `today_utc` | Default: `YYYY-MM-DD`. (--date deferred to v1.1) |
| `ChargeCategory` | string | **Yes** | `"Usage"` | Static. |
| `BilledCost` | decimal | **Yes** | `calculateCost()` | Primary cost field (USD). |
| `ResourceId` | string | No | `prompt_id` / slug | Stable grouping identifier. |
| `ResourceType` | string | No | `"LLM"` | Static. |
| `RegionId` | string | No | `""` | Empty string (Global API). |
| `ServiceCategory` | string | No | `"AI and Machine Learning"` | Static. |
| `ServiceName` | string | **Yes** | `"LLM Inference"` | Static. |
| `ConsumedQuantity` | decimal | No | `input + output` | Total tokens. |
| `ConsumedUnit` | string | Cond. | `"Tokens"` | Required if Quantity provided. |
| `Tags` | JSON | No | See below | All metadata encoded here. |

### Columns moved into Tags (Vantage Workaround)
Vantage rejects many standard FOCUS columns. We encode them into Tags:

| Field | Tag Key |
| :--- | :--- |
| ResourceName (path) | `resource-name` |
| Provider | `provider` |
| EffectiveCost | `effective-cost` |
| Token Counts | `x-token-count-input`, `x-token-count-output` |
| Cache Ratio | `x-cache-hit-ratio` |
| Content Hash | `x-content-hash` |

### Tags JSON Structure
All metadata goes into Tags (valid JSON object, CSV-escaped):
```json
{
  "llm-cost-type": "estimate",
  "provider": "OpenAI",
  "model": "gpt-4o",
  "resource-name": "prompts/search.txt",
  "effective-cost": "0.0041",
  "x-token-count-input": "1847",
  "x-token-count-output": "523",
  "x-cache-hit-ratio": "0.60",
  "x-content-hash": "a1b2c3d4",
  "team": "platform",
  "app": "search"
}
```

## Appendix A: Complete CSV Example

```csv
ChargePeriodStart,ChargeCategory,BilledCost,ResourceId,ResourceType,RegionId,ServiceCategory,ServiceName,ConsumedQuantity,ConsumedUnit,Tags
2025-12-12,Usage,0.0041,search,LLM,,AI and Machine Learning,LLM Inference,2370,Tokens,"{""llm-cost-type"":""estimate"",""provider"":""OpenAI"",""model"":""gpt-4o"",""resource-name"":""prompts/search.txt"",""effective-cost"":""0.0041"",""x-token-count-input"":""1847"",""x-token-count-output"":""523"",""x-cache-hit-ratio"":""0.60"",""x-content-hash"":""a1b2c3d4"",""team"":""platform"",""app"":""search""}"
2025-12-12,Usage,0.0028,summarize,LLM,,AI and Machine Learning,LLM Inference,1650,Tokens,"{""llm-cost-type"":""estimate"",""provider"":""OpenAI"",""model"":""gpt-4o"",""resource-name"":""prompts/summarize.txt"",""effective-cost"":""0.0028"",""x-token-count-input"":""1200"",""x-token-count-output"":""450"",""x-content-hash"":""d4e5f6g7"",""team"":""platform"",""app"":""search""}"
2025-12-12,Usage,0.0003,classify,LLM,,AI and Machine Learning,LLM Inference,890,Tokens,"{""llm-cost-type"":""estimate"",""provider"":""OpenAI"",""model"":""gpt-4o-mini"",""resource-name"":""prompts/classify.txt"",""effective-cost"":""0.0003"",""x-token-count-input"":""720"",""x-token-count-output"":""170"",""x-content-hash"":""g7h8i9j0"",""team"":""ml"",""app"":""triage""}"
2025-12-12,Usage,0.0120,api-auth,LLM,,AI and Machine Learning,LLM Inference,3200,Tokens,"{""llm-cost-type"":""estimate"",""provider"":""Anthropic"",""model"":""claude-3-5-sonnet"",""resource-name"":""src/prompts/auth.txt"",""effective-cost"":""0.0120"",""x-token-count-input"":""2800"",""x-token-count-output"":""400"",""x-content-hash"":""j1k2l3m4"",""team"":""security"",""app"":""auth""}"
2025-12-12,Usage,0.0085,onboarding-welcome,LLM,,AI and Machine Learning,LLM Inference,2100,Tokens,"{""llm-cost-type"":""estimate"",""provider"":""OpenAI"",""model"":""gpt-4o"",""resource-name"":""prompts/onboarding/welcome.txt"",""effective-cost"":""0.0085"",""x-token-count-input"":""1600"",""x-token-count-output"":""500"",""x-cache-hit-ratio"":""0.85"",""x-content-hash"":""m4n5o6p7"",""team"":""growth"",""app"":""onboarding""}"
```

### Tag Value Rules
*   **Strings Only**: `"1847"` not `1847`.
*   **Precision**: Costs (4 decimals), Ratios (2 decimals).
*   **Sparse**: Omit empty/null values.
*   **Kebab-case**: `resource-name`, `effective-cost`.


---

## 4. Implementation Details

### Memory Management (Zero-Leak)
The `FocusRow` struct will own its dynamic strings to ensure safe teardown.

```zig
pub const FocusRow = struct {
    allocator: std.mem.Allocator,

    // Core Fields
    charge_period_start: []const u8, // Owned
    billed_cost: f64,
    resource_id: []const u8,         // Owned
    consumed_quantity: u64,

    // Tag Data (HashMap)
    tags: std.StringHashMap([]const u8), // Owned keys/values

    pub fn deinit(self: *FocusRow) void {
        self.allocator.free(self.charge_period_start);
        self.allocator.free(self.resource_id);

        var it = self.tags.iterator();
        while (it.next()) |entry| {
            self.allocator.free(entry.key_ptr.*);
            self.allocator.free(entry.value_ptr.*);
        }
        self.tags.deinit();
    }
};
```

### Date Handling
Use `std.time.timestamp()` converted to `YYYY-MM-DD` via `std.time.epoch.EpochSeconds`. Zig standard library provides sufficient tools without external deps.

---

## 5. Verification Plan

### Test Vectors
1.  **Header Check**: Verify CSV header matches the 11-column strict subset.
2.  **Date Format**: Verify `ChargePeriodStart` is `YYYY-MM-DD`.
3.  **JSON Escaping**: Ensure tags with quotes (`"`) are properly escaped in the CSV field.
4.  **Memory**: Run with `GPA` to ensure 0 leaks during export.

### Manual Validation
1.  Export sample project.
2.  Import to Vantage "Custom Provider".
3.  Verify:
    *   Costs appear.
    *   Date is recognized.
    *   Tags are filterable.
