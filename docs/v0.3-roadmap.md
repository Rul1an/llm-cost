# v0.3 Implementation Roadmap

## Epic 1 – o200k whitespace-correctheid
**Doel**: o200k-scanner doet exact wat tiktoken doet voor whitespace (Branches 5–7), inclusief CRLF-gedrag.
*   [ ] Update `docs/o200k_pre_tokenizer.md` met gedragsvoorbeelden.
*   [ ] Refactor `src/tokenizer/o200k_scanner.zig` (split `tryScanWhitespaceGroup`).
*   [ ] Add Unit tests `src/tokenizer/o200k_scanner_test.zig` (specifieke edge cases).
*   [ ] **Exit**: Alle whitespace-tests groen, geen diff op Evil Corpus.

## Epic 2 – cl100k scanner & specials
**Doel**: Volwaardige cl100k-support met eigen scanner, vocab en special tokens.
*   [ ] Documenteer cl100k regex & specials (uit `tiktoken` source).
*   [ ] Implementeer `src/tokenizer/cl100k_scanner.zig` (dedicated struct).
*   [ ] Vul `EncodingSpec` met cl100k data (vocab, specials).
*   [ ] Unit tests voor `Cl100kScanner`.
*   [ ] **Exit**: cl100k parity op Evil Corpus.

## Epic 3 – Evil Corpus v2 & parity harness
**Doel**: Statische JSONL-corpus + parity-test die tiktoken en llm-cost vergelijkt.
*   [ ] `tools/gen_evil_corpus.py` (pinned tiktoken version).
*   [ ] Genereer `testdata/evil_corpus_v2.jsonl`.
*   [ ] Update `src/test/parity.zig` om Evil Corpus te lezen.
*   [ ] Update `build.zig` target `test-parity`.
*   [ ] **Exit**: `zig build test-parity` groen (o200k/cl100k).

## Epic 4 – BPE datastructuren & worst-case gedrag
**Doel**: BPE-engine met platte rank-map, lineair gedrag ook op adversarial input.
*   [ ] Analyseer huidige geheugen-layout.
*   [ ] Ontwerp en implementeer "Flat Rank Map" (contiguous arrays).
*   [ ] Add Worst-case microbenchmarks ("a"*N, emoji-runs) om empirisch lineair gedrag te bewijzen.
*   [ ] **Exit**: Lineair gedrag, geen regressie in parity.

## Epic 5 – Allocatie-reductie & ASCII fast-paths
**Doel**: minder allocaties in hot paths, makkelijke winst in scanner.
*   [ ] Flamegraph audit van pipe-mode.
*   [ ] Optimaliseer Arena-gebruik in worker pool.
*   [ ] Implementeer ASCII bitsets (128-bit) voor scanners.
*   [ ] **Exit**: Meetbare speedup, minder allocs in profiel.

## Epic 6 – Performance benchmarks & regressie-bewaking
**Doel**: meetbare, reproduceerbare performance.
*   [ ] Benchmark tool/script voor 100MB JSONL scenario.
*   [ ] Establish Baseline v0.2.
*   [ ] Run Scenario B (Multi-thread) en log scaling.
*   [ ] **Exit**: Scenario A >10x sneller dan v0.2.

## Epic 7 – Crash/UB fuzzing
**Doel**: structureel fuzzing inzetten om panics/UB te voorkomen.
*   [ ] Fuzz-target `engine.estimateTokens`.
*   [ ] Harness `src/fuzz/fuzz_tokenizer.zig`.
*   [ ] CI Workflow `fuzz.yml`.
*   [ ] **Exit**: Fuzz-job draait stabiel >1u. Gevonden bugs = nieuwe regression-test.

## Epic 8 – CI & release polishing
**Doel**: v0.3 release flow compleet en betrouwbaar houden.
*   [ ] Integreer parity-check in release.
*   [ ] Update docs (release checklist, performance).
*   [ ] **Exit**: Release workflow produceert binaries/SBOM/Signatures.
