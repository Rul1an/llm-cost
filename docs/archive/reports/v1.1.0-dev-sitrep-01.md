# Situation Report: v1.1.0 "Shift Left" (Core & Diff)

**Date**: 2025-12-12
**Status**: ðŸŸ¢ ON TRACK
**Phase**: Core Infrastructure & CLI Diff (Completed)
**Toolchain**: Zig 0.14.0 (Strict Compliance verified via `zvm`)

## Executive Summary
We have successfully implemented the foundational components for the "Shift Left" strategy. The `llm-cost diff` command is now fully operational, capable of comparing local changes against Git history (`HEAD`, `main`, etc.) and outputting results in Table, JSON, or Markdown formats. Critical security and stability hardening has been applied to the core git integration.

## Key Accomplishments

### 1. Robust Core Infrastructure (`src/core/`)
*   **`git_show.zig`**: Implemented a secure wrapper around `git show` with strict path validation (rejecting `..`, `:`, and absolute paths) and safe exit code parsing. Includes hermetic tests using temporary repositories.
*   **`file_provider.zig`**: Created a unified provider interface for FS and Git content, ensuring filesystem operations respect the repository root context.
*   **`delta.zig`**: Refined the `DeltaModel` to use optional costs (`?i128`). This allows accurate distinction between:
    *   **Added**: Base is `null`, Head is `>0`.
    *   **Removed**: Base is `>0`, Head is `null`.
    *   **Free/Zero**: Base/Head are `0` (not `null`).

### 2. CLI Diff Command (`src/diff.zig`)
*   **Usage**: `llm-cost diff --base <ref> --head <ref> --format <table|json|markdown>`
*   **Features**:
    *   **Deterministic Output**: Differential changes are sorted by Importance (High -> Low), Delta Magnitude (High -> Low), and Resource ID.
    *   **Multiple Formats**:
        *   `table`: Human-readable terminal output.
        *   `json`: Machine-readable for CI/Action processing.
        *   `markdown`: GitHub-ready formatted tables for PR comments.

### 3. Verification & Compliance
*   **Zig 0.14.0 Support**: Verified build and test pass on Zig 0.14.0 (fixing 0.15 incompatibilities).
*   **Memory Safety**: Addressed string ownership issues in `computeDeltas` to ensure `CostDelta` structs remain valid after manifest teardown.

## Upcoming Milestones
*   **Phase 3: GitHub API Client**: Implementing a REST client to enabling PR comment posting ("Sticky Comments").
*   **Phase 4: CI Action Command**: Logic to detecting CI environments (`GITHUB_EVENT_PATH`) and enforcing budget gates.

## Risks & Blockers
*   **None**. Integration is proceeding according to plan.
