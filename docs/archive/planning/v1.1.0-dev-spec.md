# v1.1.0 Development Specification — “Shift Left” (TOTAL)

## Codename: “Shift Left”

**Status:** Ready for Implementation
**Target:** Q1 2026
**Predecessor:** v1.0.0 (FOCUS Export)
**Effort:** **7–10 days**

---

## 1. Executive Summary

v1.1.0 brings LLM cost visibility "shift-left" to PRs:

* **P0: `llm-cost ci-action`** (NEW): Single CLI command handling PR context, base/head comparison, gates, and sticky comments.
* **P0: GitHub Action `llm-cost/action@v1`**: Thin wrapper to download binary and run `ci-action`.
* **P0: `diff` command**: Local/CI cost comparison between refs.
* **P0: Sticky PR comments**: Native GitHub API client (no spam).
* **P0: Budget gate**: (+ optional fail-on-increase).

**Core Principles**
* **Offline-first:** Embedded pricing DB, no SaaS/API key.
* **Supply-chain minimalism:** No third-party actions/deps (custom `gh`, `jq` removed).
* **Hermetic & Testable:** Logic in Zig, not Bash.

### SOTA Drivers (2025)
* **Supply-chain Reality:** Minimize third-party actions; recommend SHA pinning.
* **Fork Safety:** Support `pull_request_target` via `git show` (no checkout of PR code with write token).

---

## 2. Architecture

**Decision:** Move CI logic from bash to `llm-cost ci-action`.

**Why:**
* Removes checkout-dance fragility (files missing in base).
* Removes runtime dependencies (`jq`, `bc`, `gh`).
* Enables unit/integration testing of gates/comments.

**New Architecture:**
* Composite action: download binary → `llm-cost ci-action …`
* `ci-action` executes:
  1. Detect PR context (`$GITHUB_EVENT_PATH`).
  2. **Base**: Read via `git show <base_sha>:<path>` (No checkout).
  3. **Head**: Read from workspace (default) or `git show` (fork-safe).
  4. Calc Delta + Gates.
  5. Post/Update Comment via embedded REST client.

---

## 3. CLI: `llm-cost ci-action`

### Usage
```bash
llm-cost ci-action [OPTIONS]
```

### Flags
| Flag | Default | Description |
| :--- | :--- | :--- |
| `--manifest <path>` | `llm-cost.toml` | Manifest path |
| `--repo-dir <path>` | `.` | Repo root (with `.git`) |
| `--event-path <path>` | `$GITHUB_EVENT_PATH` | GitHub event JSON |
| `--base-ref <ref>` | auto | Base git ref/sha |
| `--head-ref <ref>` | auto | Head git ref/sha |
| `--token <token>` | `$GITHUB_TOKEN` | GitHub API token |
| `--post-comment` | `auto` | `true`, `false`, `auto` (skip on fork if no permission) |
| `--comment-threshold` | `0` | Min absolute $ delta to comment |
| `--comment-marker` | `<!-- llm-cost-action-comment -->` | Sticky marker |
| `--budget <usd>` | - | Override budget limit |
| `--fail-on-increase` | `false` | Fail if delta > 0 |
| `--format` | `github` | Output format (`github` writes to env vars) |

### Outputs (GitHub Actions)
Writes to `$GITHUB_OUTPUT` / `$GITHUB_STEP_SUMMARY`:
* `total-cost`, `base-cost`, `cost-delta`, `delta-percent`
* `exit-code`, `commented`

### Exit Codes
| Code | Meaning |
| :--- | :--- |
| 0 | Pass |
| 2 | Budget exceeded / Increase violation |
| 3 | Policy violation |
| 4 | Pricing DB error |
| 5 | Manifest error |

---

## 4. CLI: `llm-cost diff`

### Usage
```bash
llm-cost diff --base <ref> [--head <ref>] [--manifest <path>] [--format table|json|markdown]
```

### Semantics
* **Providers**: Same as `ci-action` (FS vs GitShow).
* **Sorting**: Increased (High Impact) > Added > Decreased > Removed > Unchanged.

---

## 5. GitHub Action: `llm-cost/action@v1` (Composite)

**Location**: `.github/actions/llm-cost/action.yml`

This composite action downloads the binary and runs `ci-action`.

```yaml
name: "LLM Cost Check"
description: "Shift-left LLM cost analysis for PRs via llm-cost ci-action."
inputs:
  manifest: { default: "llm-cost.toml" }
  version: { default: "action" } # resolves to tag or latest
  budget: { required: false }
  fail-on-increase: { default: "false" }
  post-comment: { default: "auto" }
  verify-sha256: { default: "true" }
runs:
  using: "composite"
  steps:
    - name: Setup llm-cost
      shell: bash
      run: |
        set -euo pipefail
        # ... logic to download binary & verify checksum ...
    - name: Run llm-cost ci-action
      shell: bash
      run: |
        set -euo pipefail
        "$LLM_COST_BIN" ci-action ...
```

---

## 6. Implementation Plan (7-10 Days)

### Day 1: Core Providers
* `src/core/git_show.zig`: Wraps `git -C repo show <sha>:<path>`.
* `src/core/file_provider.zig`: Interface for FS vs Git reading.
* **AC**: Missing files handled typed; Max size guard.

### Day 2: Delta Model
* `src/core/delta.zig`: Comparison logic.
* **AC**: Status enum (Added/Removed/Inc/Dec/Same). Deterministic sort.

### Day 3: Diff Command
* `src/diff.zig`.
* **AC**: `llm-cost diff --base main` works. Table/JSON/Markdown outputs.

### Day 4: GitHub API Client
* `src/core/github_api.zig`: Embedded REST client.
* **AC**: `listComments`, `create`, `update` (PATCH). Search by marker.

### Day 5: CI Action Command
* `src/ci_action.zig`.
* **AC**: Event parsing, Gates checks, Fork safety logic. Output vars.

### Day 6: Composite Action & Docs
* `.github/actions/llm-cost/action.yml`.
* Docs: `docs/guide/github-action.md`.
* **AC**: Valid action.yml, documentation on SHA pinning.

### Day 7: E2E Tests
* `.github/workflows/llm-cost-e2e.yml`.
* **AC**: Hermetic repo simulation in tests.

### Day 8-9: Hardening
* Rate limits, escaping, reliability.

### Day 10: Release
* Tag v1.1.0, publish logic.

---

## 7. Security & Reliability Checklist
* [ ] No third-party actions (except `checkout`).
* [ ] `set -euo pipefail` in all bash steps.
* [ ] Minimized permissions (`contents: read`, `pull-requests: write`).
* [ ] Binary checksum verification (SHA256).
