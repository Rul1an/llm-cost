# Specification: v1.1.1 "Hardening"

**Date**: 2025-12-12
**Status**: SPEC READY
**Codename**: Hardening
**Predecessor**: v1.1.0 ("Shift Left")
**Successor**: v1.2.0

## Executive Summary
v1.1.1 is a stability and security hardening release for the FOCUS export, diff, ci-action, and release pipeline. The goal is to ensure deterministic outputs, strict input bounds, and stronger supply-chain guarantees without expanding features.

## 1. Determinism (P0)
**Scope**: `estimate --format json`, `diff --format json`, `export --format focus` (including Tags JSON-in-CSV), and PR comment markdown.

### 1.1 Actions
*   **Sort Order**:
    *   `prompts`: `resource_id` ASC (or impact-sort where relevant).
    *   `deltas`: Maintain current priority sort but add tie-breakers (`resource_id`, `path`).
*   **JSON Key Order**:
    *   Implement RFC 8785 lexicographic key sorting (ASCII-only keys byte-order is equivalent).
    *   Eliminate HashMap iteration order in output: always "collect keys → sort → emit".

### 1.2 Currency Precision
*   **Choice**: Fixed precision formatting.
*   **Requirement**: Print USD values with fixed precision (e.g., 6 or 10 decimals) to stabilize string output against platform variance.
*   **Internal**: prefer `i128` fixed-point (pico-USD) where possible to avoid near-boundary rounding.

## 2. JSON Canonicalization (RFC 8785 subset)
### 2.1 Hard Constraints
*   **Tags**: Keys must be ASCII (lowercase + digits + `_` + `-`). Enforce in code.
*   **Whitespace**: Emit without whitespace.
*   **Escaping**: Strictly follow JSON rules.

### 2.2 Implementation Strategy
*   Single canonical rule for all objects (System + User tags mixed):
    1.  Collect all keys.
    2.  Sort keys.
    3.  Emit in order.

## 3. Input Hardening (P0/P1)
### 3.1 Pricing DB Limits (`parser.zig`)
*   `MAX_JSON_SIZE`: e.g., 10MB.
*   `MAX_MODELS`, `MAX_TIERS_PER_MODEL`.
*   `MAX_STRING_TOTAL_BYTES`: Optional OOM guard.

### 3.2 Minisign Limits (`crypto.zig`)
*   **Base64**: Check `decoded_len <= buffer` before decoding.
*   **Record Size**: Enforce expected sizes (64/74 bytes) before decode.
*   **Line Length**: Enforce max line length (e.g., 8KB) to prevent DoS.

## 4. CI Determinism (P0)
*   **Multi-seed Job**: Run tests N times with random seeds.
*   **Output Hashing**: Run export/estimate/diff M times and verify SHA256 hashes match.

## 5. Release Supply Chain (P0)
### 5.1 Checksums
*   Publish `checksums.txt` with `shasum` compatible format: `<sha256>  <filename>`.
*   Ensure asset names match `install.sh` expectations (`llm-cost-linux-x86_64`, etc.).

### 5.2 Attestations (SLSA)
*   Integrate `actions/attest-build-provenance@v3`.
*   Permissions: `id-token: write`, `attestations: write`.
*   Document SHA pinning in README.

## 6. Documentation / DX
*   **README**:
    *   Correct "offline" pitch: "Online during install, offline during run".
    *   New Quickstart with `init` and workflow snippet.
    *   Explain fork PR comment behavior ("auto").
*   **Verification**:
    *   Document how to verify `checksums.txt` and attestations.
