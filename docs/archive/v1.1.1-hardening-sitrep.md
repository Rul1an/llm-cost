# Situation Report: v1.1.1 "Hardening" Phase
**Date**: 2025-12-12
**Status**: COMPLETED / READY FOR RELEASE
**Objective**: Determinism, Input Hardening, Supply Chain Security.

## 1. Executive Summary
The "Hardening" phase has been successfully executed. We have eliminated non-deterministic outputs across JSON and CSV formats, implemented strict input bounds for parsing logic, and fortified the release pipeline with SOTA supply-chain security measures.

**Outcome**: The system now produces bit-for-bit identical outputs for identical inputs, ensuring reliable integration with caching and diffing tools.

## 2. Deliverables Implemented

### A. Core Determinism (RFC 8785)
*   **Module**: `src/core/json_canonical.zig` implemented.
    *   Enforces lexicographical key sorting (ASCII byte-order).
    *   Eliminates whitespace to normalize output size.
*   **Integrations**:
    *   `diff.zig`: `formatJson` now emits sorted keys and stable float formatting.
    *   `estimate.zig`: Prompts are sorted by `resource_id`. Cost strings use fixed precision.
    *   `focus/csv.zig`: Tags JSON column is now strictly canonical (System keys first, then sorted User keys).

### B. Input Validation (Security)
*   **Pricing DB**: Added `MAX_JSON_SIZE` (10MB) and `MAX_MODELS` (1000) limits to `parser.zig` to prevent memory exhaustion attacks.
*   **Minisign**: Added strict 8KB line length limit and buffer bounds checks to `crypto.zig` to prevent decoder exploits or DoS.

### C. Release Pipeline
*   **Checksums**: The release workflow now generates a `checksums.txt` file in `shasum -a 256` format (`<hash>  <filename>`) alongside binaries.
*   **SLSA**: Upgraded to `actions/attest-build-provenance@v2` for compliant build attestations.

### D. Verification (CI)
*   **Script**: Created `scripts/verify-determinism.sh`.
    *   Runs `estimate` and `export` 5 times in a loop.
    *   Asserts SHA256 of output is identical across all runs.
*   **Workflow**: Added `.github/workflows/determinism.yml` to run this check on every PR.

## 3. Verification Results
*   **Build**: `zig build` (Success).
*   **Tests**: `zig build test` (Success, including new `json_canonical` tests).
*   **Determinism**: `verify-determinism.sh` passed 5/5 runs locally.
*   **Lint/fmt**: Codebase clean.

## 4. Next Steps
1.  **Release**: Tag `v1.1.1` (or `v1.1.0` if this is merged before the major launch).
2.  **Deploy**: The Release workflow will automatically sign and attest the new hardened binaries.
